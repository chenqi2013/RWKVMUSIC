name: Build

on: [push, pull_request, workflow_dispatch]

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.get_version.outputs.VERSION }}
    steps:
    - name: get-version
      id: get_version
      run: echo "VERSION=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT

  # windows-x64-vs2022:
  #   needs: [setup]
  #   runs-on: windows-latest
  #   env:
  #     VERSION: ${{ needs.setup.outputs.VERSION }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Setup Flutter SDK
  #       uses: flutter-actions/setup-flutter@v3
  #       with:
  #         channel: stable
  #     - name: Install dependencies
  #       run: |
  #         cd rwkvmusic
  #         flutter pub get
  #     - name: Build Windows x64
  #       run: |
  #         cd rwkvmusic
  #         flutter build windows
  #     - name: Package Windows x64
  #       run: |
  #         C:\msys64\usr\bin\wget.exe https://uwuhome.momosan.cc:3000/molly/rwkvmusic-models/releases/download/master/release-windows-x64.zip
  #         7z x release-windows-x64.zip
  #         cd rwkvmusic
  #         mkdir build/windows/x64/runner/Release/lib/
  #         mkdir build/windows/x64/runner/Release/lib/fastmodel
  #         Copy-Item -Path ../runtime/* -Destination build/windows/x64/runner/Release/lib/fastmodel -Recurse
  #         Copy-Item -Path ../weights/* -Destination build/windows/x64/runner/Release/lib/fastmodel -Recurse
  #         cd build/windows/x64/runner/
  #         7z a -r ../../../../../rwkvmusic-windows-x64-${{env.VERSION}}.zip Release
  #     - name: Upload Windows x64
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: rwkvmusic-windows-x64-${{env.VERSION}}
  #         path: rwkvmusic-windows-x64-${{env.VERSION}}.zip

  windows-arm64-vs2022:
    needs: [setup]
    runs-on: windows-11-arm
    env:
      VERSION: ${{ needs.setup.outputs.VERSION }}
    steps:
      - name: Check system architecture
        run: |
        echo "Architecture: $env:PROCESSOR_ARCHITECTURE"
      - name: Checkout
        uses: actions/checkout@v4

      # (可选，但推荐) 安装 Visual Studio 构建工具
      - name: Install Visual Studio Build Tools
        uses: microsoft/setup-msbuild@v1.3
        with:
          vs-version: 'latest'
          msbuild-architecture: 'arm64'
          components: 'Microsoft.VisualStudio.Component.VC.Tools.ARM64;Microsoft.VisualStudio.Component.Windows10SDK.19041' # Adjust if needed

      # (可选) 安装 7-Zip
      - name: Install 7-Zip
        run: choco install 7zip -y --force

      # --- Manual Flutter SDK Installation (Using Beta Channel) ---
      - name: Download Flutter SDK (Beta)
        shell: pwsh
        run: |
          # Find the latest beta version from: https://docs.flutter.dev/release/archive?tab=windows (look under Beta channel)
          # Or just try a recent known beta, e.g., 3.23.0-1.0.pre
          $flutterChannel = "beta"
          # Let's try a known recent beta version, adjust if needed
          # Check https://docs.flutter.dev/release/archive?tab=windows for latest beta
          $flutterVersion = "3.27.0-0.1.pre" # Example beta version
          $flutterZip = "flutter_windows_${flutterVersion}-${flutterChannel}.zip"
          $downloadUrl = "https://storage.googleapis.com/flutter_infra_release/releases/${flutterChannel}/windows/$flutterZip"
          Write-Host "Downloading Flutter SDK ($flutterChannel - $flutterVersion) from $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile $flutterZip -ErrorAction Stop
          Write-Host "Extracting Flutter SDK..."
          Expand-Archive -Path $flutterZip -DestinationPath C:\ -ErrorAction Stop # Extract to C:\flutter
          Remove-Item $flutterZip
          Write-Host "Flutter SDK extracted to C:\flutter"

      - name: Add Flutter to PATH
        shell: pwsh
        run: |
          echo "C:\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "Adding C:\flutter\bin to PATH"

      - name: Verify Flutter Installation & Enable Desktop
        run: |
          flutter --version
          flutter config --enable-windows-desktop
          flutter doctor -v

      # --- Build Steps ---
      - name: Install dependencies
        run: |
          cd rwkvmusic
          flutter pub get

      - name: Build Windows arm64
        run: |
          cd rwkvmusic
          # This flag should now be recognized with a recent beta version
          flutter build windows

      # --- Packaging and Upload Steps ---
      - name: Package Windows arm64
        run: |
          Invoke-WebRequest -Uri https://uwuhome.momosan.cc:3000/molly/rwkvmusic-models/releases/download/master/release-windows-arm64.zip -OutFile release-windows-arm64.zip
          7z x release-windows-arm64.zip
          cd rwkvmusic
          Copy-Item -Path ../runtime/* -Destination build/windows/x64/runner/Release/ -Recurse
          Copy-Item -Path ../weights/* -Destination build/windows/x64/runner/Release/lib/fastmodel -Recurse
          cd build/windows/x64/runner/
          7z a -r ../../../../../rwkvmusic-windows-arm64-${{env.VERSION}}.zip Release

      - name: Upload Windows arm64
        uses: actions/upload-artifact@v4
        with:
          name: rwkvmusic-windows-arm64-${{env.VERSION}}
          path: rwkvmusic-windows-arm64-${{env.VERSION}}.zip
  
  # android:
  #   needs: [setup]
  #   runs-on: ubuntu-latest
  #   env:
  #     VERSION: ${{ needs.setup.outputs.VERSION }}
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Set Up Java
  #       uses: actions/setup-java@v3.12.0
  #       with:
  #         distribution: 'oracle'
  #         java-version: '17'
  #     - name: Setup Flutter SDK
  #       uses: flutter-actions/setup-flutter@v3
  #       with:
  #         channel: stable
  #     - name: Install dependencies
  #       run: |
  #         cd rwkvmusic
  #         flutter pub get
  #     - name: Build APK
  #       run: |
  #         cd rwkvmusic
  #         flutter build apk --release
  #     - name: Upload Artifacts
  #       uses: actions/upload-artifact@v3
  #       with:
  #         name: rwkvmusic-android-${{env.VERSION}}
  #         path: |
  #           rwkvmusic/build/app/outputs/flutter-apk/app-release.apk